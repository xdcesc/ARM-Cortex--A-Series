# 第三章：ARM 处理器模式和寄存器

ARM 架构是一个模型架构，在引入安全扩展之前它有7个处理器模式，在 Table3-1 中列出。存在 6 个特权模式和 1 个非特权用户模式。特权是一中执行那些不能被用户模式执行的特定任务的能力。在用户模式中，在系统配置等方面的操作是受到限制的，例如 MMU 配置和缓存操作。模式同时也与在十一章要提到的异常处理相关。![](/assets/table3-1.png)在引入 TrustZone Security 扩展之后，为处理器创造了两种独立于特权和处理器模式的安全状态，并且用一个新的监控\(Monitor\)模式最为在安全状态和非安全状态作侨联，并独立于任何一种安全状态。![](/assets/figure3-1.png)TrustZone Security 扩展在第二十一章讲解，但在现在，对于实现 TrustZone 扩展的处理器来说，系统安全可以通过为设备分隔所有的硬软件资源至两个世界，有安全子系统的安全世界和除此以外的正常世界。一旦当一个处理器在非安全状态，它就不能与分配到安全状态的内存相通。

在这种情形下，Secure Monitor 就承担了两种模式之间转换网关的作用。

如果安全扩展一旦被实现，在监控模式下执行的软件就可以在安全和非安全处理器状态相互转换，并都能运行。

ARMv7 架构中 Virtualization 扩展在特权模式\(privileded mode\)的基础上新添加了一个超特权模式 hypervisor mode \(Hyp\)。虚拟化允许多个操作共存和运行在同一个系统上。ARM 虚拟化扩展因此使得在同一平台上运行多操作系统提供了可能性。![](/assets/figure3-2.png)如果虚拟化扩展被实现，则有一个特权模型与之前的架构不同。在非安全状态下，这里存在三个特权等级，PL0、PL1 和 PL2。

---

**PL0**

在用户模式下执行的软件（应用程序）会被描述为非特权软件，权利级别位于 PL0。这些软件不能与架构的一些特征相通，尤其不能改变许多配置信息。

在 PL0 特权下执行的软件只能做非特权内存通信。

**PL1**

除了用户和超特权模式以外的模式下执行的软件，权利级别都位于 PL1，通常下操作系统位于 PL1 级别。

PL1 模式则是指除了用户和超特权模式以外的所有模式。

一个操作系统位于 PL1 模式，但是应用程序却是在 PL0 特权下执行（用户模式执行）。

**PL2**

超特权模式通常被管理员使用，他们能够随意转换在 PL1 特权下运行的客户操作系统。

如果虚拟化扩展被实现，那么管理员将在 PL2 下执行\(Hyp mode\)。管理员将控制所有多操作系统来选择共存和在相同处理器上执行。

---

这些特权等级被 TrustZone Secure 和 Normal 设置所隔离开。

**\_\_\_\_\_\_\_\_**_**Note**_**\_\_\_\_\_\_\_\_\_\_**

**权利等级定义了访问当前安全状态的资源的能力，并且表明访问其他安全状态的资源的能力。**

**\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_**

Figure 3-3 表明了在不同处理器状态下可行的处理器模式![](/assets/figure3-3.png)![](/assets/table3-2.png)一个通常意义上的操作系统例如 Linux 和其应用程序，最好在非安全状态下运行，安全状态更希望运行安全敏感的软件或者设备供应商的固定软件。在这种情形下，运行在安全状态下的软件的特权应比运行在非安全状态下的软件特权高。

现在的处理器模式和执行状态在 _Current Program Status Register_ \(CPSR\) 寄存器中记录。改变处理器状态和模式可能是由显式的特权软件，也可能是链接相关区域的异常导致。

