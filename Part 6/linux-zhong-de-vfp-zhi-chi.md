## Linux 中的 VFP 支持

使用 VFP \(或调用使用 VFP 的库\) 的应用程序对 Linux 内核提出了一些附加要求。为了使应用程序正确运行，内核必须在上下文切换期间保存和恢复 VFP 寄存器。在 VFP 硬件不存在的情况下，内核可能还需要解码和模拟 VFP 指令。

### 上下文切换

除了保存和恢复整数寄存器外，内核还必须在上下文切换上执行 VFP 寄存器的保存和恢复。为了避免浪费周期，只有当应用程序实际使用 VFP 时才会这样做。因为 VFP 初始化代码使 VFP 禁用，所以当线程第一次尝试访问浮点硬件时，就会出现未定义的异常。处理这个的 kernel 函数会看到 VFP 被禁用，并且一个新的线程想要使用 VFP。它保存当前的 VFP 状态并为新线程恢复状态。

在集群中，线程可以迁移到不同的核心，这个简单的系统将不再正确工作。相反，如果前面的线程使用了 VFP，内核会保存状态。



