## ARM tools 汇编语言

ARM 工具现在使用的统一汇编语言 \(Unified Assembly Language UAL\) 格式允许 ARM 和 Thumb 指令集使用相同的规范语法。ARM 工具的汇编语法与 GNU 汇编器所用的语法不相同，特别是用于预处理和不直接映射到操作码的伪指令。在下一章中，我们将更详细地研究单个汇编语言指令。在此之前，我们先看一下用于指定指令和寄存器的基本语法。本书中的汇编语言示例同时使用 UAL 和 GNU 汇编语法。

UAL 提供了编写汇编器代码的能力，这些汇编器代码可以在所有 ARM 内核上运行。在过去，需要为 ARM 或 Thumb 状态显式地编写代码。使用 UAL，相同的代码在汇编的时候可以汇编不同的指令集代码，而不需要在编写代码作区分。这可以通过使用命令行开关或内联指令来实现。遗留代码仍将正确组装。值得注意的是，GNU 汇编器现在通过使用 `.syntax` 指令来支持 UAL，尽管它可能与 ARM tools 汇编器的语法不同。

### ARM 汇编语法

ARM 汇编语言源文件包含一系列语句，每句一行。

每个语句都有三个可选部分，顺序如下排列：

`label instruction ; comment`

`label` 让你定义这条指令的地址，可用作分支指令或加载和存储指令的目标。

`instruction` 可以是 ARM 汇编指令，也可以是汇编器指令。这些伪指令告诉汇编程序自己要做什么。指令在三个部分中是最必须的，是控制部分和对齐或创建数据所必需的。

每个在 `;` 符号后边的被看做是一个注释并且可被忽略（除非在字符串当中）。C 语言中的注释 "`/**/`" 也能被使用。

### Labels

从一行的第一个字符开始需要一个标签。如果该行没有标签，则需要一个空格或制表符分隔符来启动该行。如果有标签，汇编器会使标签等于对应指令的目标文件中的地址。由此，标签可以用作分支机构或装载和存储的目标。![](/assets/example4-3.png)在 Example 4-3 中，`Loop` 是一个标签并且条件分支指令（`BNE Loop`）将以使分支指令中编码的偏移量指向与标签循环关联的 MUL 指令的地址的方式进行汇编。

### Directives（汇编器指令）

大多数行正常地都有一条汇编语言指令，这会被汇编工具等价的转化成二进制文件，或者会有一条汇编器指令用于告知汇编器来做某项工作。它也可以是伪指令\(汇编器会将其转换为一个或多个真正的指令\)。我们将在第 5 章中查看硬件中的实际指令，并主要关注那的汇编器指令。它们执行广泛的任务。它们可以用于将代码或数据放在内存中的特定地址，创建对其他程序的引用等等。

例如定义常数的指令 Define Constant \(`DCD`,`DCB`,`DCW`\) 让你将数据放入一段代码中。可以用数字（十进制、十六进制、二进制）或 ASCII 字符表示。它可以是单个项目，也可以是逗号分隔的列表。`DCB` 表示字节大小的数据，`DCD`表示字大小的数据，`DCW`表示半字大小的数据项。

例如我们可能有

`MESSAGE DCB "Hello World!", 0`

这条指令将产生一系列与字符串中的 ASCII 字符对应的字节，并以 0 终止。`MESSAGE` 是一个 label，我们可以使用它来获取数据的地址。类似地，我们可能有以十六进制表示的数据项:

`Masks DCD 0x100, 0x80, 0x40, 0x20, 0x10`

`EQU` 指令允许你为地址或数据值分配名称。

`CtrlD EQU 4`

`TUBE EQU 0x30000000`

然后，我们可以在其他指令中使用这些名称，作为要计算的表达式的一部分。等式实际上不会导致任何东西被放在程序可执行文件中——它只是为值设置了一个名称，以便在汇编程序的符号表中的其他指令中使用。使用这样的名称使代码更容易阅读是很方便的，但是如果我们更改了代码中的某个地址或值，我们必须修改原始定义，而不是必须单独更改对它的所有引用。通常情况下，可以在程序或函数的开头，或在单独的 include 文件中，将等式定义分组在一起。

`AREA`伪指令用于告诉汇编器如何将代码或数据分组到逻辑部分，以便链接器稍后放置。例如，异常向量可能需要放在一个固定的地址。汇编器跟踪每个指令或数据块在内存中的位置。`AREA`指令可用于修改该位置。

`ALIGN`指令允许将当前位置对齐到指定的边界。它通常通过用 0 或 `NOP` 指令填充（必要时）来实现这一点，尽管也可以用指令指定填充值。默认行为是将当前位置设置为下一个单词\(4字节\)边界，但也可以指定更大的边界大小和该边界的偏移量。这可以用于满足某些指令的对齐要求\(例如 `LDRD` 和 `STRD` 双字内存传输\)，或与缓存边界对齐。`ALIGN n` 与 GNU 汇编器一样给二的 n 次方对齐 ARM 内核。











